//
//  SettingsView.swift
//  WeBudget
//
//  Created by Pierre-Louis L'ALLORET on 14/09/2025.
//

// SettingsView.swift
import SwiftUI

struct SettingsView: View {
    @EnvironmentObject var budgetManager: BudgetManager
    @State private var showingExportSheet = false
    @State private var showingClearAlert = false
    @State private var showingSeuil = false
    @State private var exportData = ""
    
    var body: some View {
        NavigationView {
            Form {
                // NOUVELLE SECTION: Navigation vers les fonctionnalit√©s
                Section("Fonctionnalit√©s") {
                    NavigationLink {
                        ConfigurationView()
                            .navigationBarBackButtonHidden(false)
                    } label: {
                        Label("Configuration budgets", systemImage: "gearshape.fill")
                            .font(.appCallout) // Space Grotesk Regular
                    }
                    
                    NavigationLink {
                        RecurringExpensesView()
                            .navigationBarBackButtonHidden(false)
                    } label: {
                        Label("D√©penses r√©currentes", systemImage: "arrow.clockwise")
                            .font(.appCallout) // Space Grotesk Regular
                            .badge(budgetManager.dueRecurringExpenses.count)
                    }
                    
                    NavigationLink {
                        SavingsGoalsView()
                            .navigationBarBackButtonHidden(false)
                    } label: {
                        Label("Objectifs d'√©pargne", systemImage: "target")
                            .font(.appCallout) // Space Grotesk Regular
                            .badge(budgetManager.behindScheduleGoals.count)
                    }
                }
                
                Section("Sauvegarde des donn√©es") {
                    Button {
                        exportDataToJSON()
                    } label: {
                        Label("Exporter les donn√©es", systemImage: "square.and.arrow.up")
                            .font(.appCallout) // Space Grotesk Regular
                    }
                    
                    Button {
                        showingClearAlert = true
                    } label: {
                        Label("Effacer toutes les donn√©es", systemImage: "trash")
                            .font(.appCallout) // Space Grotesk Regular
                            .foregroundColor(.red)
                    }
                }
                
                Section("Personnalisation") {
                    
                    NavigationLink {
                        NotificationSettingsView()
                    } label: {
                        Label("Notifications", systemImage: "bell.fill")
                            .font(.appCallout) // Space Grotesk Regular
                    }
                    
                    NavigationLink {
                        ThemeSettingsView()
                    } label: {
                        Label("Apparence", systemImage: "paintbrush.fill")
                            .font(.appCallout) // Space Grotesk Regular
                    }
                }
                
                Section("Informations") {
                    HStack {
                        Text("Version")
                            .font(.appCallout) // Space Grotesk Regular
                        Spacer()
                        Text("1.0.0")
                            .font(.appCallout) // Space Grotesk Regular
                            .foregroundColor(.secondary)
                    }
                    
                    HStack {
                        Text("Transactions")
                            .font(.appCallout) // Space Grotesk Regular
                        Spacer()
                        Text("\(budgetManager.transactions.count)")
                            .font(.appCallout) // Space Grotesk Regular
                            .foregroundColor(.secondary)
                    }
                    
                    HStack {
                        Text("D√©penses r√©currentes")
                            .font(.appCallout) // Space Grotesk Regular
                        Spacer()
                        Text("\(budgetManager.recurringExpenses.count)")
                            .font(.appCallout) // Space Grotesk Regular
                            .foregroundColor(.secondary)
                    }
                    
                    HStack {
                        Text("Objectifs d'√©pargne")
                            .font(.appCallout) // Space Grotesk Regular
                        Spacer()
                        Text("\(budgetManager.savingsGoals.count)")
                            .font(.appCallout) // Space Grotesk Regular
                            .foregroundColor(.secondary)
                    }
                    
                    HStack {
                        Text("CloudKit")
                            .font(.appCallout) // Space Grotesk Regular
                        Spacer()
                        Text(budgetManager.isAuthenticated ? "Connect√©" : "D√©connect√©")
                            .font(.appCallout) // Space Grotesk Regular
                            .foregroundColor(budgetManager.isAuthenticated ? .green : .red)
                    }
                }
                
                Section("Pr√©f√©rences syst√®me") {
                    HStack {
                        Text("Mode sombre")
                            .font(.appCallout) // Space Grotesk Regular
                        Spacer()
                        Text("Automatique")
                            .font(.appCallout) // Space Grotesk Regular
                            .foregroundColor(.secondary)
                    }
                    
                    HStack {
                        Text("Notifications")
                            .font(.appCallout) // Space Grotesk Regular
                        Spacer()
                        Text("Activ√©es")
                            .font(.appCallout) // Space Grotesk Regular
                            .foregroundColor(.green)
                    }
                    
                    HStack {
                        Text("Devise")
                            .font(.appCallout) // Space Grotesk Regular
                        Spacer()
                        Text("EUR (‚Ç¨)")
                            .font(.appCallout) // Space Grotesk Regular
                            .foregroundColor(.secondary)
                    }
                }
            }
            .navigationTitle("Param√®tres")
            .alert("Effacer toutes les donn√©es", isPresented: $showingClearAlert) {
                Button("Annuler", role: .cancel) {
                    // Action Annuler
                }
                .font(.buttonText) // Space Grotesk Medium
                Button("Effacer", role: .destructive) {
                    clearAllData()
                }
                .font(.buttonText) // Space Grotesk Medium
            } message: {
                Text("Cette action est irr√©versible. Toutes vos donn√©es seront supprim√©es d√©finitivement.")
                    .font(.appCallout) // Space Grotesk Regular
            }
            .sheet(isPresented: $showingExportSheet) {
                ShareSheet(activityItems: [exportData])
            }
            .sheet(isPresented: $showingSeuil) {
                ConfigurationView()
            }
        }
    }
    
    private func exportDataToJSON() {
        let exportModel = ExportModel(
            salaires: budgetManager.salaires,
            budgets: budgetManager.budgets,
            transactions: budgetManager.transactions,
            recurringExpenses: budgetManager.recurringExpenses,
            savingsGoals: budgetManager.savingsGoals
        )
        
        do {
            let encoder = JSONEncoder()
            encoder.dateEncodingStrategy = .iso8601
            encoder.outputFormatting = .prettyPrinted
            
            let jsonData = try encoder.encode(exportModel)
            exportData = String(data: jsonData, encoding: .utf8) ?? ""
            showingExportSheet = true
        } catch {
            print("Erreur lors de l'export: \(error)")
        }
    }
    
    private func clearAllData() {
        budgetManager.transactions.removeAll()
        budgetManager.recurringExpenses.removeAll()
        budgetManager.savingsGoals.removeAll()
        budgetManager.salaires = Salaires(pilou: 6000, doudou: 10000)
        budgetManager.budgets = Budgets()
        
        // Sauvegarder les changements
        budgetManager.saveSalaires()
        budgetManager.saveBudgets()
        // TODO: Ajouter la suppression CloudKit pour les nouvelles entit√©s
    }
    
    private func contactSupport() {
        if let url = URL(string: "mailto:support@webudget.app?subject=Support%20WeBudget") {
            UIApplication.shared.open(url)
        }
    }
}

// MARK: - Nouvelles vues de navigation

struct NotificationSettingsView: View {
    @State private var expenseAlerts = true
    @State private var budgetWarnings = true
    @State private var recurringReminders = true
    @State private var savingsGoalUpdates = true
    @State private var weatherSuggestions = false
    
    var body: some View {
        Form {
            Section("üì± Types de notifications") {
                Toggle("üö® Alertes de d√©passement", isOn: $expenseAlerts)
                    .font(.appCallout) // Space Grotesk Regular
                Toggle("‚ö†Ô∏è Alertes budget (90%)", isOn: $budgetWarnings)
                    .font(.appCallout) // Space Grotesk Regular
                Toggle("üîÑ Rappels r√©currents", isOn: $recurringReminders)
                    .font(.appCallout) // Space Grotesk Regular
                Toggle("üéØ Objectifs d'√©pargne", isOn: $savingsGoalUpdates)
                    .font(.appCallout) // Space Grotesk Regular
                Toggle("üå§Ô∏è Suggestions m√©t√©o", isOn: $weatherSuggestions)
                    .font(.appCallout) // Space Grotesk Regular
            }
            
            Section("‚è∞ Fr√©quence") {
                HStack {
                    Text("Rappels r√©currents")
                        .font(.appCallout) // Space Grotesk Regular
                    Spacer()
                    Text("2 jours avant")
                        .font(.appCallout) // Space Grotesk Regular
                        .foregroundColor(.secondary)
                }
                
                HStack {
                    Text("V√©rification budget")
                        .font(.appCallout) // Space Grotesk Regular
                    Spacer()
                    Text("Quotidienne")
                        .font(.appCallout) // Space Grotesk Regular
                        .foregroundColor(.secondary)
                }
            }
        }
        .navigationTitle("üîî Notifications")
        .navigationBarTitleDisplayMode(.inline)
    }
}

struct ThemeSettingsView: View {
    @State private var selectedTheme: AppTheme = .system
    @State private var accentColor: Color = .blue
    
    var body: some View {
        Form {
            Section("üé® Th√®me g√©n√©ral") {
                Picker("Mode d'affichage", selection: $selectedTheme) {
                    Text("üåç Automatique")
                        .font(.appCallout) // Space Grotesk Regular
                        .tag(AppTheme.system)
                    Text("‚òÄÔ∏è Clair")
                        .font(.appCallout) // Space Grotesk Regular
                        .tag(AppTheme.light)
                    Text("üåô Sombre")
                        .font(.appCallout) // Space Grotesk Regular
                        .tag(AppTheme.dark)
                }
                .pickerStyle(SegmentedPickerStyle())
            }
            
            Section("üåà Couleur d'accentuation") {
                LazyVGrid(columns: Array(repeating: GridItem(.flexible()), count: 6), spacing: 15) {
                    ForEach([Color.blue, Color.green, Color.orange, Color.red, Color.purple, Color.teal], id: \.self) { color in
                        Circle()
                            .fill(color)
                            .frame(width: 30, height: 30)
                            .overlay(
                                Circle()
                                    .stroke(Color.primary, lineWidth: accentColor == color ? 2 : 0)
                            )
                            .onTapGesture {
                                accentColor = color
                            }
                    }
                }
            }
            
            Section("üìä Graphiques") {
                Toggle("üé® Graphiques color√©s", isOn: .constant(true))
                    .font(.appCallout) // Space Grotesk Regular
                Toggle("üìà Animations", isOn: .constant(true))
                    .font(.appCallout) // Space Grotesk Regular
            }
        }
        .navigationTitle("üé® Apparence")
        .navigationBarTitleDisplayMode(.inline)
    }
}

struct HelpView: View {
    var body: some View {
        ScrollView {
            LazyVStack(alignment: .leading, spacing: 20) {
                HelpSection(
                    icon: "üí∞",
                    title: "Gestion des budgets",
                    content: "Configurez vos revenus et budgets mensuels dans l'onglet Configuration. L'application calcule automatiquement vos proportions et votre reste disponible."
                )
                
                HelpSection(
                    icon: "üí≥",
                    title: "Ajout de transactions",
                    content: "Appuyez sur + dans l'onglet D√©penses pour ajouter une nouvelle transaction. S√©lectionnez la cat√©gorie, le montant et qui a pay√©."
                )
                
                HelpSection(
                    icon: "üîÑ",
                    title: "D√©penses r√©currentes",
                    content: "Cr√©ez des d√©penses qui se r√©p√®tent automatiquement (loyer, abonnements, etc.). L'application vous rappellera quand elles sont dues."
                )
                
                HelpSection(
                    icon: "üéØ",
                    title: "Objectifs d'√©pargne",
                    content: "Fixez-vous des objectifs d'√©pargne avec des dates limites. Suivez votre progression et recevez des encouragements."
                )
                
                HelpSection(
                    icon: "üå§Ô∏è",
                    title: "Suggestions m√©t√©o",
                    content: "L'application analyse la m√©t√©o pour vous sugg√©rer des √©conomies (cuisiner par temps de pluie, activit√©s gratuites au soleil, etc.)."
                )
                
                HelpSection(
                    icon: "‚òÅÔ∏è",
                    title: "Synchronisation",
                    content: "Vos donn√©es sont automatiquement synchronis√©es via iCloud entre tous vos appareils Apple connect√©s au m√™me compte."
                )
            }
            .padding()
        }
        .navigationTitle("üìñ Guide")
        .navigationBarTitleDisplayMode(.inline)
    }
}

struct HelpSection: View {
    let icon: String
    let title: String
    let content: String
    
    var body: some View {
        VStack(alignment: .leading, spacing: 8) {
            HStack {
                Text(icon)
                    .font(.title2)
                Text(title)
                    .font(.appHeadline) // Space Grotesk SemiBold
                    .fontWeight(.semibold)
            }
            
            Text(content)
                .font(.appSubheadline) // Space Grotesk Medium
                .foregroundColor(.secondary)
                .fixedSize(horizontal: false, vertical: true)
        }
        .padding()
        .background(Color.gray.opacity(0.1))
        .cornerRadius(12)
    }
}

struct AboutView: View {
    var body: some View {
        ScrollView {
            VStack(spacing: 30) {
                // Logo et nom de l'app
                VStack(spacing: 10) {
                    Image(systemName: "wallet.pass.fill")
                        .font(.system(size: 60))
                        .foregroundColor(.blue)
                    
                    Text("WeBudget")
                        .font(.appTitle) // Space Grotesk SemiBold
                        .fontWeight(.bold)
                    
                    Text("Version 1.0.0")
                        .font(.appSubheadline) // Space Grotesk Medium
                        .foregroundColor(.secondary)
                }
                
                // Description
                VStack(alignment: .leading, spacing: 15) {
                    Text("√Ä propos")
                        .font(.appHeadline) // Space Grotesk SemiBold
                        .fontWeight(.bold)
                    
                    Text("WeBudget est une application de gestion budg√©taire con√ßue sp√©cialement pour les couples. Elle vous aide √† g√©rer vos finances communes tout en respectant vos contributions proportionnelles.")
                        .font(.appSubheadline) // Space Grotesk Medium
                        .foregroundColor(.secondary)
                }
                
                // Fonctionnalit√©s
                VStack(alignment: .leading, spacing: 15) {
                    Text("Fonctionnalit√©s principales")
                        .font(.appHeadline) // Space Grotesk SemiBold
                        .fontWeight(.bold)
                    
                    VStack(alignment: .leading, spacing: 8) {
                        FeatureRow(icon: "üí∞", text: "Gestion proportionnelle des revenus")
                        FeatureRow(icon: "üìä", text: "Suivi des budgets par cat√©gorie")
                        FeatureRow(icon: "üîÑ", text: "D√©penses r√©currentes automatiques")
                        FeatureRow(icon: "üéØ", text: "Objectifs d'√©pargne personnalis√©s")
                        FeatureRow(icon: "üå§Ô∏è", text: "Suggestions bas√©es sur la m√©t√©o")
                        FeatureRow(icon: "‚òÅÔ∏è", text: "Synchronisation iCloud")
                    }
                }
                
                // Cr√©dits
                VStack(alignment: .leading, spacing: 15) {
                    Text("Cr√©dits")
                        .font(.appHeadline) // Space Grotesk SemiBold
                        .fontWeight(.bold)
                    
                    Text("D√©velopp√© avec ‚ù§Ô∏è par Pierre-Louis L'ALLORET")
                        .font(.appSubheadline) // Space Grotesk Medium
                        .foregroundColor(.secondary)
                    
                    Text("Utilise WeatherKit d'Apple pour les donn√©es m√©t√©orologiques")
                        .font(.appCaption) // Space Grotesk Regular
                        .foregroundColor(.secondary)
                }
                
                // Contact
                VStack(spacing: 10) {
                    Button("üìß Contact") {
                        if let url = URL(string: "mailto:contact@webudget.app") {
                            UIApplication.shared.open(url)
                        }
                    }
                    .font(.buttonText) // Space Grotesk Medium
                    .buttonStyle(.borderedProminent)
                    
                    Button("‚≠ê Noter l'app") {
                        // Action pour noter l'app
                    }
                    .font(.buttonText) // Space Grotesk Medium
                    .buttonStyle(.bordered)
                }
            }
            .padding()
        }
        .navigationTitle("√Ä propos")
        .navigationBarTitleDisplayMode(.inline)
    }
}

struct FeatureRow: View {
    let icon: String
    let text: String
    
    var body: some View {
        HStack {
            Text(icon)
            Text(text)
                .font(.appSubheadline) // Space Grotesk Medium
            Spacer()
        }
    }
}

// MARK: - Types d'aide

enum AppTheme: CaseIterable {
    case system, light, dark
}

// MARK: - ExportModel mis √† jour

struct ExportModel: Codable {
    let salaires: Salaires
    let budgets: Budgets
    let transactions: [Transaction]
    let recurringExpenses: [RecurringExpense]
    let savingsGoals: [SavingsGoal]
    let exportDate: Date = Date()
}

// MARK: - ShareSheet (inchang√©)

struct ShareSheet: UIViewControllerRepresentable {
    let activityItems: [Any]
    
    func makeUIViewController(context: Context) -> UIActivityViewController {
        UIActivityViewController(activityItems: activityItems, applicationActivities: nil)
    }
    
    func updateUIViewController(_ uiViewController: UIActivityViewController, context: Context) {}
}
